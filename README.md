# ESP32-S3 SLCAN Bridge (SavvyCAN compatible)

Turn an ESP32-S3 into a **USB-to-CAN (SLCAN/Lawicel)** adapter that works with **SavvyCAN** (and other SLCAN tools).
Builds with **ESP-IDF 5.x**, runs on ESP32-S3, and expects a CAN transceiver on **GPIO4 (TX)** and **GPIO5 (RX)**.

---

## Features

* Speaks **SLCAN (Lawicel)** over the ESP32-S3’s **native USB-Serial/JTAG** port (shows up as a COM/tty device).
* **Listen-only** or **active** mode.
* **Bitrate selection** via standard `Sx` commands (10k … 1M).
* **11-bit (standard) & 29-bit (extended)** CAN frames (`t`/`T`).
* Optional **1 ms timestamps** (`Z1`/`Z0`).
* Minimal, robust implementation designed for **SavvyCAN**.

> Not CAN-FD. ESP-TWAI (classic CAN) only.

---

## Hardware

### Pins

* **TWAI TX** → `GPIO4` → transceiver **TXD**
* **TWAI RX** → `GPIO5` → transceiver **RXD**
* **GND** → transceiver **GND**
* **3V3** → transceiver **VCC** (use a **3.3 V-IO transceiver**)

Popular 3.3 V CAN transceivers: **SN65HVD230**, **MCP2562FD (3.3 V variant)**, **TJA1051T/3**.
Avoid 5 V-only parts like **TJA1050** unless you level-shift IO.

### Bus connection

* Connect **CANH** and **CANL** to your vehicle or test bus.
* Ensure **120 Ω termination** at both ends of the bus (or a single 120 Ω across CANH/CANL for short bench loops).
* If your transceiver has **STB/EN/RS** pins, ensure they’re set to **normal mode** (pull to the correct level).

---

## Build & Flash (ESP-IDF 5.x)

1. **Set target** (once per project):

   ```bash
   idf.py set-target esp32s3
   ```

2. **Build & flash**:

   ```bash
   idf.py build flash
   ```

3. **Monitor** (optional):

   ```bash
   idf.py monitor
   ```

   You should see something like:

   ```
   I (0) SLCAN: SLCAN bridge starting (USB CDC + TWAI)
   ```

### File layout

* `main/slcan_esp32s3.c` (your main file)
* `CMakeLists.txt`, `sdkconfig` as generated by ESP-IDF

> The code includes the right headers and uses `usb_serial_jtag`, so no extra Kconfig is needed for the USB console.

---

## Using with SavvyCAN

1. Plug the ESP32-S3 into your PC. It appears as:

   * **Windows**: a COM port (no extra drivers needed)
   * **Linux**: `/dev/ttyACM*` or `/dev/ttyUSB*`
   * **macOS**: `/dev/tty.usbmodem*`

2. Open **SavvyCAN** → **Connections** → **Add New Connection** → **Serial connection (SLCAN)**.

   * Select the ESP32-S3 serial device.
   * Speed setting in SavvyCAN typically doesn’t matter for SLCAN; default is fine.

3. Typical init sequence (SavvyCAN or manual terminal):

   ```
   C       ; Close if open
   S6      ; Set 500 kbit/s (see table below)
   L       ; Open in listen-only (or 'O' for active/ACK+TX)
   ```

   You should start seeing frames in SavvyCAN.

### Supported SLCAN commands

* `Sx` — set bitrate **before** open:

  * `S0` 10k, `S1` 20k, `S2` 50k, `S3` 100k, `S4` 125k, `S5` 250k, `S6` 500k, `S7` 800k, `S8` 1M
* `O` — **Open** bus (active mode, ACK allowed, TX enabled)
* `L` — Open bus **listen-only** (no ACK, TX disabled)
* `C` — **Close** bus
* `t`/`T` — **Transmit** standard/extended data frames
* `Z0`/`Z1` — timestamps **off/on** (1 ms, 16-bit wrap)
* `V`/`v`/`N` — version/hardware/name response

**Emitted frame format**

* Standard: `tIII DL D0 D1 ... \r`
* Extended: `TIIIIIIII DL D0 D1 ... \r`
* With timestamps (`Z1`): append 4 hex digits (1 ms, 16-bit wrap) before `\r`.

> RTR frames and filter commands (`m/M`) are not implemented in this minimal build. Ask if you need them.

---

## Changing pins or defaults

* **Pins**: edit the defines near the top:

  ```c
  #define TWAI_TX_GPIO 4
  #define TWAI_RX_GPIO 5
  ```
* **Default bitrate**: the `timing` global is initialized to 500 kbit/s. You can change:

  ```c
  static twai_timing_config_t timing = TWAI_TIMING_CONFIG_500KBITS();
  ```

  or just send an `Sx` command before opening.

---

## Troubleshooting

* **No serial device appears**

  * Use the **native USB** port of the ESP32-S3 (USB-Serial/JTAG). Try a different cable/port.
* **SavvyCAN connects but shows no frames**

  * Confirm wiring (TXD↔GPIO4, RXD↔GPIO5).
  * Make sure bus has proper **termination** and your transceiver is **enabled**.
  * Try **listen-only** (`L`) first to avoid disrupting the bus.
  * Verify the **bitrate** (`Sx`) matches the bus speed.
* **Build error: `expected expression before '{' token` for timing macros**

  * You’re already fixed: the code uses **compound literal casts**
    `(twai_timing_config_t)TWAI_TIMING_CONFIG_500KBITS()`.
* **`ESP_RETURN_ON_ERROR` undefined**

  * ESP-IDF 5.x: ensure `#include "esp_check.h"` is present (already included).

---

## Limitations

* **Classic CAN (TWAI) only**. **No CAN-FD**.
* Minimal SLCAN command set; filters and RTR TX omitted in this version.
* Timestamp is **1 ms** resolution with **16-bit wrap** (common SLCAN practice).

---

## Example terminal session

You can talk to it via a serial terminal (send `\r` after each command):

```
V\r
V1013\r
v\r
vESP32S3\r
N\r
NESPS3\r
C\r
S6\r
L\r
```

Incoming frames will look like:

```
t1A0 8 1122334455667788 3F2A\r
T18FF50E5 8 0001020304050607 7C91\r
```

(Spaces added here for readability; actual output is contiguous hex.)

---

## Safety notes

* In **active mode** (`O`) the adapter **ACKs** frames and can **transmit**. Use **listen-only** (`L`) for passive sniffing on sensitive vehicle networks.
* Ensure you understand the legal and safety implications of connecting to in-vehicle networks.

---

## License

MIT (or your preferred license). Add a `LICENSE` file if you plan to share this publicly.

---

## Credits

* Built on **ESP-IDF** TWAI (classic CAN) and **USB-Serial/JTAG** drivers.
* Targeted for **SavvyCAN** compatibility via **SLCAN (Lawicel)** protocol.
